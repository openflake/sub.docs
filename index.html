<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
  <link rel="icon" href="//cdn.cloudseat.net/favicon.png"/>
  <link rel="stylesheet" href="_assets/css/docs.css"/>
  <link rel="stylesheet" href="_assets/css/rouge.css"/>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <title>战国册 / 文档库</title>
</head>
<body>

<aside>
  <div class="logo">
    <span class="emoji">🧔</span>
    <span class="text">战国册 / 文档库</span>
  </div>
  <div class="search"><input type="search" placeholder="搜索..."/></div>
  <div id="jekydocs-summary"></div>
</aside>

<main id="jekydocs-content"></main>
<div id="jekydocs-toc">
  <div><a href="">常见网速</a></div>
  <div><a class="active" href="">基础设备</a></div>
  <div><a href="">终端设备</a></div>
  <div><a href="">网络布局</a></div>
  <div><a href="">注意事项</a></div>
</div>

<script>
function fetch(url, callback) {
  let xhr = new XMLHttpRequest()
  xhr.onreadystatechange = function() {
    if (this.readyState == 4) {
      if (this.status == 404) {
        console.error('Page not found.')
      }
      if (this.status == 200) {
        callback(this.responseText)
      }
    }
  }
  xhr.open("GET", url, true)
  xhr.send()
}

const Toc = {
  toc: [],
  add: function(obj) {
    this.toc.push(obj)
  },
  clear: function() {
    this.toc = []
  },
  html: function() {
    let html = '<div>文档目录</div>'
    this.toc.forEach((entry, index) => {
      if (index > 0) {
        html += '<a class="toc-' + entry.level + '" href="#' + entry.anchor + '">' + entry.text + '<a>'
      }
    })
    this.clear()
    return html
  }
}

let renderer = new marked.Renderer();
renderer.heading = function(text, level, raw) {
  let anchor = this.options.headerPrefix + raw.toLowerCase().replace(/[^\w\\u4e00-\\u9fa5]]+/g, '-');
  Toc.add({ anchor, level, text })
  return `<h${level} id="${anchor}">${text}</h${level}>`
}

marked.setOptions({
  renderer: renderer,
})

let lastClicked = null

fetch('SUMMARY.md', res => {
  document.querySelector('#jekydocs-summary').innerHTML = marked(res)
  Toc.clear()

  let summary = document.querySelectorAll('#jekydocs-summary a')
  summary.forEach(link => {
    link.onclick = function() {
      if (lastClicked)
      lastClicked.className = ''
      lastClicked = link
      link.className = 'active'

      fetch(link.href.split('#')[1], res => {
        document.querySelector('#jekydocs-content').innerHTML = marked(res)
        document.querySelector('#jekydocs-toc').innerHTML = Toc.html()
      })
    }
  })
})

fetch('README.md', res => {
  document.querySelector('#jekydocs-content').innerHTML = marked(res)
  document.querySelector('#jekydocs-toc').innerHTML = Toc.html()
})
</script>

</body>
</html>
